#include <msp430.h>
#include <stdint.h>
#include "lcd.h"
#include "digit.h"
#include "timer.h"

#include "gear.h"

static const uint8_t GEAR_DATA_DIGITS[] = { 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
		0x0, 0x0, 0x0, 0x3c, 0x0, 0x0, 0x3c, 0x0, 0x0, 0x3c, 0x0, 0x0, 0x3c,
		0x0, 0x0, 0x3c, 0x0, 0x0, 0x3c, 0x0, 0x0, 0x3c, 0x0, 0x0, 0x3c, 0x0,
		0x0, 0x3c, 0x0, 0x0, 0x3c, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
		0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x38, 0x0, 0x0, 0x3c, 0x0, 0x0, 0x3c,
		0x0, 0x0, 0x3c, 0x0, 0x0, 0x3c, 0x0, 0x0, 0xfe, 0xff, 0x7f, 0xfe, 0xff,
		0x7f, 0xfe, 0xff, 0x7f, 0xff, 0xff, 0x7f, 0xff, 0xff, 0x7f, 0x0, 0x0,
		0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0xf8, 0x0, 0x78, 0xfc,
		0x0, 0x7c, 0xfe, 0x0, 0x7e, 0xfe, 0x0, 0x7f, 0x7f, 0xc0, 0x7f, 0x1f,
		0xe0, 0x7f, 0xf, 0xf0, 0x7f, 0xf, 0xf8, 0x7b, 0xf, 0xfc, 0x79, 0x3f,
		0xff, 0x78, 0xff, 0x7f, 0x78, 0xfe, 0x1f, 0x78, 0xfe, 0xf, 0x78, 0xfc,
		0x7, 0x78, 0xf0, 0x1, 0x78, 0x0, 0x0, 0x78, 0x20, 0x0, 0x7, 0x38, 0x0,
		0x1f, 0x3c, 0x0, 0x1f, 0x3e, 0x0, 0x3f, 0x3e, 0x0, 0x3f, 0x3f, 0x1e,
		0x7e, 0xf, 0x1e, 0x78, 0xf, 0x1e, 0x78, 0xf, 0x1e, 0x78, 0xf, 0x1e,
		0x78, 0x1f, 0x3f, 0x7c, 0xff, 0xff, 0x7f, 0xfe, 0xff, 0x3f, 0xfe, 0xfb,
		0x3f, 0xfc, 0xf3, 0x1f, 0xf8, 0xe0, 0xf, 0x0, 0xe0, 0x3, 0x0, 0xf8, 0x3,
		0x0, 0xfe, 0x3, 0x0, 0xff, 0x3, 0xc0, 0xdf, 0x3, 0xe0, 0xcf, 0x3, 0xf8,
		0xc3, 0x3, 0xfe, 0xc0, 0x3, 0xff, 0xff, 0x7f, 0xff, 0xff, 0x7f, 0xff,
		0xff, 0x7f, 0xff, 0xff, 0x7f, 0xff, 0xff, 0x7f, 0xff, 0xff, 0x7f, 0x0,
		0xc0, 0x3, 0x0, 0xc0, 0x3 }; //!< Pixeldaten der Ziffern der Gänge, siehe gfx/digits_gear.png

// Einstellung der Gänge
static const uint8_t GEAR_VALUE_HIGH[] = { 110, 55, 40 }; // Maximum des Parameters
static const uint8_t GEAR_VALUE_LOW[] = { 90, 45, 30 };	// Minimum des Parameters
static const uint8_t GEAR_COUNT = 3;						// Anzahl der Gänge

static const uint8_t GEAR_X = 85;	//!< Position der Anzeige
static const uint8_t GEAR_Y = 5;	//!< Y-Page

/**
 * Aktualisierung der Anzeige
 */
void gear_draw() {
	uint8_t gear = 0;
	uint8_t gear_value = gear_calculate_value();


	if (gear_value != 0) {
		// Auswählen des Ganges
		for (uint8_t i = 0; i < GEAR_COUNT; i++) {
			if (gear_value >= GEAR_VALUE_LOW[i]
					&& gear_value < GEAR_VALUE_HIGH[i]) {
				gear = i + 1;
				break;
			}
		}
	}

	// Zeichnen der Ganganzeige
	const uint8_t *pt = &(GEAR_DATA_DIGITS[16 * 3 * gear]);

	for (uint8_t i = 0; i < 16; i++) {
		for (uint8_t y = 0; y < 3; y++) {
			lcd_set_pixels(GEAR_X + i, GEAR_Y + y, *pt);
			pt++;
		}
	}
}

uint8_t gear_calculate_value() {
	uint16_t rpm_periode = timer_get_rpm_periode();
	if (rpm_periode != 0xffff && speed_periode != 0xffff) {
		return speed_periode / (rpm_periode >> 6);
	} else {
		return 0;
	}
}
