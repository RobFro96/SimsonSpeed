#include <stdint.h>
#include "lcd.h"

#include "font.h"

#if 1
// Präprozessor-Anweisung für Folding

// Pixeldaten der Zeichen, siehe gfx/font8x6.png, Erstellen mit convert-font8x6.py
static const uint8_t FONT_DATA[] = { 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x6f,
		0x0, 0x0, 0x0, 0x7, 0x0, 0x7, 0x0, 0x14, 0x7f, 0x14, 0x7f, 0x14, 0x1c,
		0x22, 0x6b, 0x2a, 0x10, 0x23, 0x13, 0x8, 0x64, 0x62, 0x36, 0x49, 0x56,
		0x20, 0x50, 0x0, 0x0, 0x7, 0x0, 0x0, 0x0, 0x1c, 0x22, 0x41, 0x0, 0x0,
		0x41, 0x22, 0x1c, 0x0, 0x14, 0x8, 0x3e, 0x8, 0x14, 0x8, 0x8, 0x3e, 0x8,
		0x8, 0x0, 0xa0, 0x60, 0x0, 0x0, 0x8, 0x8, 0x8, 0x8, 0x8, 0x0, 0x60,
		0x60, 0x0, 0x0, 0x20, 0x10, 0x8, 0x4, 0x2, 0x3e, 0x41, 0x49, 0x41, 0x3e,
		0x0, 0x42, 0x7f, 0x40, 0x0, 0x42, 0x61, 0x51, 0x49, 0x46, 0x21, 0x41,
		0x45, 0x4b, 0x31, 0x18, 0x14, 0x12, 0x7f, 0x10, 0x27, 0x45, 0x45, 0x45,
		0x39, 0x3c, 0x4a, 0x49, 0x49, 0x30, 0x1, 0x71, 0x9, 0x5, 0x3, 0x36,
		0x49, 0x49, 0x49, 0x36, 0x6, 0x49, 0x49, 0x29, 0x1e, 0x0, 0x36, 0x36,
		0x0, 0x0, 0x0, 0xac, 0x6c, 0x0, 0x0, 0x8, 0x14, 0x22, 0x41, 0x0, 0x14,
		0x14, 0x14, 0x14, 0x14, 0x0, 0x41, 0x22, 0x14, 0x8, 0x2, 0x1, 0x51, 0x9,
		0x6, 0x3e, 0x41, 0x5d, 0x49, 0x4e, 0x7e, 0x9, 0x9, 0x9, 0x7e, 0x7f,
		0x49, 0x49, 0x49, 0x36, 0x3e, 0x41, 0x41, 0x41, 0x22, 0x7f, 0x41, 0x41,
		0x41, 0x3e, 0x7f, 0x49, 0x49, 0x49, 0x41, 0x7f, 0x9, 0x9, 0x9, 0x1,
		0x3e, 0x41, 0x49, 0x49, 0x3a, 0x7f, 0x8, 0x8, 0x8, 0x7f, 0x0, 0x41,
		0x7f, 0x41, 0x0, 0x20, 0x40, 0x41, 0x3f, 0x1, 0x7f, 0x8, 0x14, 0x22,
		0x41, 0x7f, 0x40, 0x40, 0x40, 0x40, 0x7f, 0x2, 0xc, 0x2, 0x7f, 0x7f,
		0x4, 0x8, 0x10, 0x7f, 0x3e, 0x41, 0x41, 0x41, 0x3e, 0x7f, 0x9, 0x9, 0x9,
		0x6, 0x3e, 0x41, 0x51, 0x21, 0x5e, 0x7f, 0x9, 0x19, 0x29, 0x46, 0x46,
		0x49, 0x49, 0x49, 0x31, 0x1, 0x1, 0x7f, 0x1, 0x1, 0x3f, 0x40, 0x40,
		0x40, 0x3f, 0x1f, 0x20, 0x40, 0x20, 0x1f, 0x3f, 0x40, 0x38, 0x40, 0x3f,
		0x63, 0x14, 0x8, 0x14, 0x63, 0x7, 0x8, 0x70, 0x8, 0x7, 0x61, 0x51, 0x49,
		0x45, 0x43, 0x0, 0x0, 0x7f, 0x41, 0x0, 0x2, 0x4, 0x8, 0x10, 0x20, 0x0,
		0x0, 0x41, 0x7f, 0x0, 0x4, 0x2, 0x1, 0x2, 0x4, 0x40, 0x40, 0x40, 0x40,
		0x40, 0x0, 0x0, 0x3, 0x4, 0x0, 0x20, 0x54, 0x54, 0x54, 0x78, 0x7f, 0x48,
		0x44, 0x44, 0x38, 0x38, 0x44, 0x44, 0x44, 0x20, 0x38, 0x44, 0x44, 0x48,
		0x7f, 0x38, 0x54, 0x54, 0x54, 0x18, 0x8, 0x7e, 0x9, 0x1, 0x2, 0x18,
		0xa4, 0xa4, 0xa4, 0x7c, 0x7f, 0x8, 0x4, 0x4, 0x78, 0x0, 0x44, 0x7d,
		0x40, 0x0, 0x40, 0x80, 0x84, 0x7d, 0x0, 0x0, 0x7f, 0x10, 0x28, 0x44,
		0x0, 0x41, 0x7f, 0x40, 0x0, 0x7c, 0x4, 0x18, 0x4, 0x78, 0x7c, 0x8, 0x4,
		0x4, 0x78, 0x38, 0x44, 0x44, 0x44, 0x38, 0xfc, 0x24, 0x24, 0x24, 0x18,
		0x18, 0x24, 0x24, 0x28, 0xfc, 0x7c, 0x8, 0x4, 0x4, 0x8, 0x48, 0x54,
		0x54, 0x54, 0x20, 0x4, 0x3f, 0x44, 0x40, 0x20, 0x3c, 0x40, 0x40, 0x20,
		0x7c, 0x1c, 0x20, 0x40, 0x20, 0x1c, 0x3c, 0x40, 0x30, 0x40, 0x3c, 0x44,
		0x28, 0x10, 0x28, 0x44, 0x1c, 0xa0, 0xa0, 0xa0, 0x7c, 0x44, 0x64, 0x54,
		0x4c, 0x44, 0x0, 0x8, 0x36, 0x41, 0x41, 0x0, 0x0, 0x7f, 0x0, 0x0, 0x41,
		0x41, 0x36, 0x8, 0x0, 0x4, 0x2, 0x4, 0x8, 0x4, 0x0, 0x0, 0x0, 0x0, 0x0,
		0x38, 0x45, 0x44, 0x25, 0x7c };
#endif

/**
 * Zeichnen eines Zeichens in 7x5 Schriftart
 *
 * @param x			X-Position
 * @param y_page	Y-Page
 * @param c			Zeichen
 */
void font_draw_char(uint8_t x, uint8_t y_page, char c) {
	const uint8_t *pt = &(FONT_DATA[5 * (c - 32)]);

	for (uint8_t i = 0; i < 5; i++) {
		lcd_set_pixels(x + i, y_page, *pt);
		pt++;
	}

	lcd_set_pixels(x + 5, y_page, 0);
}

/**
 * Zeichnen eines Zeichens in dicker 7x5 Schriftart
 *
 * @param x			X-Position
 * @param y_page	Y-Page
 * @param c			Zeichen
 */
void font_draw_char_bold(uint8_t x, uint8_t y_page, char c) {
	const uint8_t *pt = &(FONT_DATA[5 * (c - 32)]);
	uint8_t last = 0;

	for (uint8_t i = 0; i < 6; i++) {
		uint8_t current = (i == 5) ? 0 : *pt;
		lcd_set_pixels(x + i, y_page, current | last);
		last = current;
		pt++;
	}

	lcd_set_pixels(x + 6, y_page, 0);
}

/**
 * Zeichnen eines Zeichens in 7x5 Schriftart. Dieses Zeichen kann invertiert werden
 *
 * @param x			X-Position
 * @param y_page	Y-Page
 * @param c			Zeichen
 * @param mask		Maske zur Invertierung
 */
void font_draw_char_inverted(uint8_t x, uint8_t y_page, char c, uint8_t mask) {
	const uint8_t *pt = &(FONT_DATA[5 * (c - 32)]);

	for (uint8_t i = 0; i < 5; i++) {
		lcd_set_pixels(x + i, y_page, *pt ^ mask);
		pt++;
	}

	lcd_set_pixels(x + 5, y_page, mask);
}

/**
 * Zeichnen einer Zeichenkette
 *
 * @param x			X-Position
 * @param y_page	Y-Page
 * @param str		Zeichenkette, Ende der Zeichenkette mit '\0'
 */
void font_draw_string(uint8_t x, uint8_t y_page, const char *str) {
	while (*str != 0x0) {
		font_draw_char(x, y_page, *str);
		x += 6;
		str++;
	}
}

/**
 * Zeichnen einer Zeichenkette in dicker Schrift
 *
 * @param x			X-Position
 * @param y_page	Y-Page
 * @param str		Zeichenkette, Ende der Zeichenkette mit '\0'
 */
void font_draw_string_bold(uint8_t x, uint8_t y_page, const char *str) {
	while (*str != 0x0) {
		font_draw_char_bold(x, y_page, *str);
		x += 7;
		str++;
	}
}

/**
 * Zeichnen einer Zeichenkette. Diese kann invertiert werden.
 *
 * @param x			X-Position
 * @param y_page	Y-Page
 * @param str		Zeichenkette
 * @param invert	Gibt, an ob invertiert werden soll
 */
void font_draw_string_invert(uint8_t x, uint8_t y_page, const char *str,
		uint8_t invert) {
	uint8_t mask = invert ? 0xff : 0;
	while (*str != 0x0) {
		font_draw_char_inverted(x, y_page, *str, mask);
		x += 6;
		str++;
	}
}

/**
 * Anzeigen einer maximal 5-stelligen Ganzzahl
 *
 * @param x			X-Position
 * @param y_page	Y-Page
 * @param number	Zahl, die angezeigt werden soll
 * @param digit_count	Anzahl der Stellen der Zahl, führende Nullen werden entfernt, Zahl ist entsprechend wird rechtsbündig ausgegeben
 */
void font_draw_number(uint8_t x, uint8_t y_page, uint32_t number,
		uint8_t digit_count) {
	font_draw_number_invert(x, y_page, number, digit_count, 0, 0);
}

/**
 * Anzeigen einer maximal 5-stelligen Ganzzahl. Invertierung und führenden Nullen können eingestellt werden.
 *
 * @param x				X-Position
 * @param y_page		Y-Page
 * @param number		Zahl, die angezeigt werdne sollen
 * @param digit_count	Anzahl der Stellen der Zahl
 * @param invert		Gibt, an ob invertiert werden soll
 * @param leading_zeroes	Gibt, an ob die Zahl mit führenden Nullen angezeigt werden soll
 */
void font_draw_number_invert(uint8_t x, uint8_t y_page, uint32_t number,
		uint8_t digit_count, uint8_t invert, uint8_t leading_zeroes) {
	char string[6]; // Festlegung: Maximal 5 Stellen + \0

	// Zeichenkette erstellen
	for (uint8_t digit = 0; digit < digit_count; digit++) {
		char c = '0' + (number % 10);
		string[digit_count - digit - 1] = c;
		number /= 10;
	}

	// Führende Nullen entfernen
	if (!leading_zeroes) {
		for (uint8_t digit = 0; digit < digit_count - 1; digit++) {
			if (string[digit] == '0') {
				string[digit] = ' ';
			} else {
				break;
			}
		}
	}

	// \0 setzen
	string[digit_count] = 0;

	// Anzeigen
	font_draw_string_invert(x, y_page, string, invert);
}
